<% const ph = typeof placeholder !== 'undefined' ? placeholder : "What's happening?"; %>

<div class="flex items-start space-x-3 p-4 border-b border-gray-700" data-newpost-component>
  <div class="w-10 h-10 bg-gray-500 rounded-full"></div>
  <div class="flex-1">
    <textarea data-role="content" placeholder="<%= ph %>" class="w-full bg-transparent text-sm resize-none outline-none max-h-96 overflow-hidden"></textarea>

    <!-- Image upload + multi-preview -->
    <div data-role="preview-list" class="mt-3 hidden grid grid-cols-3 gap-3"></div>

    <!-- Tag picker (cards) -->
    <div data-role="tag-picker" class="mt-4 hidden" aria-hidden="true">
      <div class="text-sm text-slate-400 mb-2">Choose a category</div>
      <div data-role="tag-grid" class="grid grid-cols-3 gap-3"></div>
    </div>

    <div class="flex justify-between items-center mt-2">
      <div class="flex items-center space-x-4 text-gray-400">
        <label class="cursor-pointer flex items-center gap-2">
          <i data-feather="image"></i>
          <span class="text-xs">Add images</span>
          <input type="file" accept="image/*,video/*" class="hidden" multiple data-role="file-input" />
        </label>
        <button type="button" data-role="toggle-tags" class="flex items-center gap-2 text-gray-400 hover:text-white focus:outline-none" aria-expanded="false">
          <i data-feather="tag"></i>
          <span class="sr-only">Add tag</span>
        </button>
      </div>
      <button data-role="submit" class="bg-purple-600 px-4 py-1 rounded-full text-sm hover:bg-purple-700">Post</button>
    </div>
  </div>

  <script>
    (function(){
      const script = document.currentScript;
      const root = script ? script.closest('[data-newpost-component]') : null;
      if (!root) {
        console.warn('newpost component: failed to resolve root element');
        return;
      }

      const ta = root.querySelector('[data-role="content"]');
      const fileInput = root.querySelector('[data-role="file-input"]');
      const previewList = root.querySelector('[data-role="preview-list"]');
      const submitBtn = root.querySelector('[data-role="submit"]');
      const toggleBtn = root.querySelector('[data-role="toggle-tags"]');
      const tagPicker = root.querySelector('[data-role="tag-picker"]');
      const tagGrid = root.querySelector('[data-role="tag-grid"]');

      if (!ta || !fileInput || !previewList || !submitBtn || !toggleBtn || !tagPicker || !tagGrid) {
        console.error('newpost component: missing required elements');
        return;
      }

      const selectedItems = [];
      let selectedCategory = null;

      const MAX_IMAGE_SIZE = 10 * 1024 * 1024; // 10MB
      const MAX_VIDEO_SIZE = 200 * 1024 * 1024; // 200MB
      const ALLOWED_IMAGE_TYPES = new Set([
        'image/jpeg',
        'image/png',
        'image/webp',
        'image/gif'
      ]);
      const ALLOWED_VIDEO_TYPES = new Set([
        'video/mp4',
        'video/quicktime',
        'video/webm',
        'video/x-matroska'
      ]);

      const formatBytes = (bytes) => {
        if (!bytes) return '0 B';
        const units = ['B', 'KB', 'MB', 'GB'];
        const tier = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), units.length - 1);
        const num = bytes / Math.pow(1024, tier);
        return `${Number.isFinite(num) ? num.toFixed(num >= 10 || tier === 0 ? 0 : 1) : 0} ${units[tier]}`;
      };

      const classifyFile = (file) => {
        if (!file || !file.type) return 'unknown';
        if (file.type.startsWith('image/')) return 'image';
        if (file.type.startsWith('video/')) return 'video';
        return 'unknown';
      };

      const validateFile = (file) => {
        if (!file) return 'Unrecognized selection';
        const kind = classifyFile(file);

        if (kind === 'image') {
          if (!ALLOWED_IMAGE_TYPES.has(file.type)) {
            return `Unsupported image format (${file.type}) for "${file.name}"`;
          }
          if (file.size > MAX_IMAGE_SIZE) {
            return `Image "${file.name}" exceeds ${formatBytes(MAX_IMAGE_SIZE)}.`;
          }
        } else if (kind === 'video') {
          if (!ALLOWED_VIDEO_TYPES.has(file.type)) {
            return `Unsupported video format (${file.type}) for "${file.name}"`;
          }
          if (file.size > MAX_VIDEO_SIZE) {
            return `Video "${file.name}" exceeds ${formatBytes(MAX_VIDEO_SIZE)}.`;
          }
        } else {
          return `Unsupported file type (${file.type || 'unknown'}) for "${file.name}"`;
        }

        if (!file.size) {
          return `File "${file.name}" appears to be empty.`;
        }

        return null;
      };

      const syncInputFiles = () => {
        try {
          const dt = new DataTransfer();
          selectedItems.forEach(item => dt.items.add(item.file));
          fileInput.files = dt.files;
        } catch {
          // Older browsers might not support DataTransfer constructor; safe to ignore.
        }
      };

      const revokePreview = (item) => {
        if (item && item.previewUrl) {
          URL.revokeObjectURL(item.previewUrl);
          item.previewUrl = null;
        }
      };

      const renderPreviews = () => {
        previewList.innerHTML = '';
        if (selectedItems.length === 0) {
          previewList.classList.add('hidden');
          return;
        }
        previewList.classList.remove('hidden');

        selectedItems.forEach((item, idx) => {
          if (!item.previewUrl) {
            item.previewUrl = URL.createObjectURL(item.file);
          }
          const cell = document.createElement('div');
          cell.className = 'relative rounded overflow-hidden bg-gray-50 flex items-center justify-center';

          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'absolute top-1 right-1 bg-white/90 hover:bg-white text-gray-700 rounded-full p-1 shadow transition transform hover:scale-105 focus:outline-none';
          removeBtn.setAttribute('aria-label', 'Remove media');
          removeBtn.dataset.index = idx.toString();
          removeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9.293l4.646-4.647a1 1 0 011.414 1.414L11.414 10.707l4.646 4.646a1 1 0 01-1.414 1.414L10 12.121l-4.646 4.646a1 1 0 01-1.414-1.414l4.646-4.646L3.94 6.06A1 1 0 015.354 4.646L10 9.293z" clip-rule="evenodd"/></svg>';

          const mediaEl = document.createElement(item.kind === 'video' ? 'video' : 'img');
          mediaEl.className = 'object-cover w-full h-32 transition-transform duration-150';
          mediaEl.src = item.previewUrl;
          if (item.kind === 'video') {
            mediaEl.controls = true;
            mediaEl.loop = true;
            mediaEl.muted = true;
            mediaEl.setAttribute('playsinline', '');
          } else {
            mediaEl.alt = 'preview';
          }

          removeBtn.addEventListener('click', (ev) => {
            ev.preventDefault();
            mediaEl.classList.add('opacity-0', 'scale-95');
            cell.classList.add('pointer-events-none');
            setTimeout(() => {
              const index = Number(ev.currentTarget.dataset.index);
              if (!Number.isNaN(index)) {
                const [removed] = selectedItems.splice(index, 1);
                revokePreview(removed);
                syncInputFiles();
                renderPreviews();
              }
            }, 180);
          });

          cell.appendChild(removeBtn);
          cell.appendChild(mediaEl);
          previewList.appendChild(cell);
        });
      };

      const resetSelectedItems = () => {
        while (selectedItems.length > 0) {
          revokePreview(selectedItems.pop());
        }
        syncInputFiles();
        renderPreviews();
      };

      const resizeTextarea = () => {
        ta.style.height = 'auto';
        ta.style.height = Math.min(ta.scrollHeight, 384) + 'px';
      };

      ta.addEventListener('input', resizeTextarea, { passive: true });
      setTimeout(resizeTextarea, 0);

      submitBtn.addEventListener('click', async () => {
        const content = ta.value.trim();
        if (!content && selectedItems.length === 0) {
          alert('Please enter some content or attach media before posting.');
          return;
        }

        const formData = new FormData();
        if (content) {
          formData.append('content', content);
        }

        selectedItems.forEach(({ file, kind }) => {
          const field = kind === 'video' ? 'media' : 'images';
          formData.append(field, file);
        });

        if (selectedCategory) {
          formData.append('category', selectedCategory);
          formData.append('tags', selectedCategory);
        }

        try {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Posting...';

          const response = await fetch('/api/posts', {
            method: 'POST',
            body: formData
          });

          if (!response.ok) {
            throw new Error('Failed to create post');
          }

          ta.value = '';
          resetSelectedItems();
          selectedCategory = null;
          renderTags();
          updateToggleState();

          // Show success message
          submitBtn.innerHTML = '<span class="flex items-center"><i data-feather="check-circle" class="w-4 h-4 mr-2 text-green-400"></i>โพสต์สำเร็จ!</span>';
          feather.replace();

          // Reset button after 2 seconds
          setTimeout(() => {
            submitBtn.innerHTML = 'Post';
            feather.replace();
          }, 2000);
        } catch (error) {
          console.error('Error creating post:', error);
          alert('Failed to create post. Please try again.');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Post';
        }
      });

      fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files || []);
        if (files.length === 0) return;

        const rejected = [];

        files.forEach((file) => {
          const error = validateFile(file);
          if (error) {
            rejected.push(error);
            return;
          }

          const kind = classifyFile(file);
          const exists = selectedItems.some(
            (item) =>
              item.file.name === file.name &&
              item.file.size === file.size &&
              item.file.lastModified === file.lastModified &&
              item.kind === kind
          );
          if (exists) return;

          selectedItems.push({
            file,
            kind,
            previewUrl: URL.createObjectURL(file)
          });
        });

        syncInputFiles();
        renderPreviews();
        fileInput.value = '';

        if (rejected.length > 0) {
          alert(rejected.join('\n'));
        }
      });

      const tags = [
        { slug: '2d-art', label: '2D Art' },
        { slug: '3d-model', label: '3D Model' },
        { slug: 'graphic-design', label: 'Graphic Design' },
        { slug: 'animation', label: 'Animation' },
        { slug: 'game', label: 'Game' },
        { slug: 'ux-ui', label: 'UX/UI design' }
      ];

      const renderTags = () => {
        tagGrid.innerHTML = '';
        tags.forEach(t => {
          const card = document.createElement('button');
          card.type = 'button';
          card.className = 'flex flex-col items-center p-3 rounded-lg bg-[#1f2743] border border-[#3b3450] text-white/90 hover:border-pink-400 transition focus:outline-none';
          card.setAttribute('data-slug', t.slug);

          const label = document.createElement('div');
          label.className = 'text-sm text-center';
          label.textContent = t.label;
          card.appendChild(label);

          if (selectedCategory === t.slug) {
            card.classList.add('ring-2', 'ring-pink-400', 'border-pink-300');
          }

          card.addEventListener('click', () => {
            selectedCategory = selectedCategory === t.slug ? null : t.slug;
            renderTags();
            updateToggleState();
          });

          tagGrid.appendChild(card);
        });
      };

      const resolveTagIcon = () => {
        if (!toggleBtn) return null;
        return toggleBtn.querySelector('[data-feather]');
      };

      const updateToggleState = () => {
        const hasSelected = Boolean(selectedCategory);
        const isOpen = tagPicker && !tagPicker.classList.contains('hidden');
        const active = hasSelected || isOpen;
        if (!toggleBtn) return;
        const iconEl = resolveTagIcon();
        if (active) {
          toggleBtn.classList.remove('text-gray-400');
          toggleBtn.classList.add('text-pink-400');
          if (iconEl) iconEl.classList.add('text-pink-400');
        } else {
          toggleBtn.classList.remove('text-pink-400');
          toggleBtn.classList.add('text-gray-400');
          if (iconEl) iconEl.classList.remove('text-pink-400');
        }
      };

      toggleBtn.addEventListener('click', () => {
        const isHidden = tagPicker.classList.toggle('hidden');
        tagPicker.setAttribute('aria-hidden', isHidden ? 'true' : 'false');
        toggleBtn.setAttribute('aria-expanded', isHidden ? 'false' : 'true');
        updateToggleState();
      });

      renderPreviews();
      renderTags();
      updateToggleState();
      if (window.feather && typeof window.feather.replace === 'function') {
        window.feather.replace();
        updateToggleState();
      }

      window.addEventListener('beforeunload', () => {
        selectedItems.forEach(revokePreview);
      });
    })();
  </script>
</div>
