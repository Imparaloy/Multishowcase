<!DOCTYPE html>
<html lang="th">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title><%= title || 'Groups' %></title>
		<script src="https://cdn.tailwindcss.com"></script>
	</head>
	<body class="bg-slate-950 text-slate-100">
		<header class="flex items-center justify-between px-6 py-4 border-b border-slate-800/80">
			<h2 class="m-0 text-xl font-semibold">กลุ่มทั้งหมด</h2>
			<button class="inline-flex items-center gap-2 rounded-md bg-indigo-600 hover:bg-indigo-500 px-3 py-2 text-sm font-semibold shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" id="openCreate">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M10 3.5a.75.75 0 01.75.75v5h5a.75.75 0 010 1.5h-5v5a.75.75 0 01-1.5 0v-5h-5a.75.75 0 010-1.5h5v-5A.75.75 0 0110 3.5z"/></svg>
				สร้างกลุ่มใหม่
			</button>
		</header>

		<main class="max-w-5xl mx-auto p-6">
			<% if (!groups || groups.length === 0) { %>
				<div class="text-center p-10 border border-dashed border-slate-800/60 rounded-xl text-slate-300" id="emptyState">
					ยังไม่มีกลุ่ม เริ่มต้นสร้างกลุ่มแรกของคุณได้เลย
				</div>
			<% } else { %>
				<div class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3" id="groupList">
					<% groups.forEach(g => { %>
						<div class="rounded-xl border border-slate-800/70 bg-slate-900 p-4">
							<h3 class="text-lg font-semibold text-slate-50"><%= g.name %></h3>
							<% if (g.description) { %>
								<p class="mt-1 text-sm text-slate-300"><%= g.description %></p>
							<% } %>
							<div class="mt-2 text-xs text-slate-400">สร้างเมื่อ: <%= new Date(g.createdAt).toLocaleString('th-TH') %></div>
						</div>
					<% }) %>
				</div>
			<% } %>
		</main>

		<!-- Modal: Create Group -->
		<div class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/70 px-4" id="backdrop" aria-hidden="true">
			<div class="w-full max-w-lg rounded-xl border border-slate-800/70 bg-slate-900 p-5 shadow-2xl" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
				<h3 id="dlgTitle" class="text-lg font-semibold mb-3">สร้างกลุ่มใหม่</h3>
				<form id="createForm" class="space-y-3">
					<div>
						<label for="name" class="block text-sm text-slate-300 mb-1">ชื่อกลุ่ม</label>
						<input type="text" id="name" name="name" required placeholder="เช่น Game Dev Squad" class="w-full rounded-lg border border-slate-700/70 bg-slate-950 px-3 py-2 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
					</div>
					<div>
						<label for="description" class="block text-sm text-slate-300 mb-1">คำอธิบาย</label>
						<textarea id="description" name="description" placeholder="บอกจุดประสงค์ของกลุ่มโดยย่อ" class="w-full min-h-[96px] rounded-lg border border-slate-700/70 bg-slate-950 px-3 py-2 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
					</div>
					<div id="errorBox" class="hidden text-sm text-rose-400"></div>
					<div class="flex items-center justify-end gap-2 pt-2">
						<button type="button" class="inline-flex items-center rounded-md border border-slate-700/70 bg-transparent px-3 py-2 text-sm text-slate-200 hover:bg-slate-800/60" id="cancelBtn">ยกเลิก</button>
						<button type="submit" class="inline-flex items-center rounded-md bg-indigo-600 hover:bg-indigo-500 px-3 py-2 text-sm font-semibold text-white" id="submitBtn">สร้างกลุ่ม</button>
					</div>
				</form>
			</div>
		</div>

		<script>
			const $ = (sel) => document.querySelector(sel);
			const openBtn = $('#openCreate');
			const backdrop = $('#backdrop');
			const cancelBtn = $('#cancelBtn');
			const form = $('#createForm');
			const errorBox = $('#errorBox');
			const submitBtn = $('#submitBtn');
			const groupList = $('#groupList');
			const emptyState = $('#emptyState');

			function openModal() {
				errorBox.classList.add('hidden');
				errorBox.textContent = '';
				backdrop.classList.remove('hidden');
				backdrop.classList.add('flex');
				$('#name')?.focus();
			}
			function closeModal() {
				backdrop.classList.add('hidden');
				backdrop.classList.remove('flex');
			}

			openBtn?.addEventListener('click', openModal);
			cancelBtn?.addEventListener('click', closeModal);
			backdrop?.addEventListener('click', (e) => { if (e.target === backdrop) closeModal(); });

			form?.addEventListener('submit', async (e) => {
				e.preventDefault();
				errorBox.classList.add('hidden');
				submitBtn.disabled = true;
				submitBtn.textContent = 'กำลังสร้าง...';
				try {
					const formData = new FormData(form);
					const payload = Object.fromEntries(formData.entries());
					const res = await fetch('/groups', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
						body: JSON.stringify(payload)
					});
					const data = await res.json().catch(() => ({}));
					if (!res.ok || !data.ok) throw new Error(data.message || 'สร้างกลุ่มไม่สำเร็จ');

					// Optimistically update list
					if (groupList) {
						const card = document.createElement('div');
						card.className = 'rounded-xl border border-slate-800/70 bg-slate-900 p-4';
						const title = document.createElement('h3');
						title.className = 'text-lg font-semibold text-slate-50';
						title.textContent = data.group?.name || payload.name;
						card.appendChild(title);
						if (payload.description) {
							const p = document.createElement('p');
							p.className = 'mt-1 text-sm text-slate-300';
							p.textContent = payload.description;
							card.appendChild(p);
						}
						const meta = document.createElement('div');
						meta.className = 'mt-2 text-xs text-slate-400';
						meta.textContent = `สร้างเมื่อ: ${new Date(data.group?.createdAt || Date.now()).toLocaleString('th-TH')}`;
						card.appendChild(meta);
						if (emptyState) emptyState.remove();
						if (!groupList) {
							// create container if it didn't exist (was empty state)
							const container = document.createElement('div');
							container.id = 'groupList';
							container.className = 'grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3';
							container.appendChild(card);
							document.querySelector('main')?.appendChild(container);
						} else {
							groupList.prepend(card);
						}
					} else {
						// If no list existed (was empty state), fallback to reload
						location.reload();
					}

					form.reset();
					closeModal();
				} catch (err) {
					errorBox.textContent = err.message || 'เกิดข้อผิดพลาด';
					errorBox.classList.remove('hidden');
				} finally {
					submitBtn.disabled = false;
					submitBtn.textContent = 'สร้างกลุ่ม';
				}
			});
		</script>
	</body>
	</html>
